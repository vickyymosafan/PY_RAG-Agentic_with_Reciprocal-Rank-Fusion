{% extends "base.html" %}
{% block title %}Neural Terminal - RAG System{% endblock %}

{% block content %}
<div class="chat-container" x-data="chatApp()">
    
    <!-- Chat Header (Terminal Bar) -->
    <div class="chat-header" style="padding: 1rem 15%; border-bottom: 1px solid var(--border-dim);">
        <div class="flex-center gap-2">
            <span class="sys-badge" style="color: var(--primary); margin-bottom: 0;">AGENTIC_CHAT</span>
            <span class="font-mono" style="font-size: 0.8rem; color: var(--text-secondary)">SECURE CHANNEL</span>
        </div>
        <div class="flex-center gap-2">
            <div class="status-indicator" :class="sessionId ? 'online' : ''"></div>
            <span class="font-mono" style="font-size: 0.75rem" x-text="sessionId ? 'CONNECTED' : 'STANDBY'"></span>
            <button @click="clearHistory()" class="btn btn-sm btn-secondary" style="margin-left: 1rem;">
                CLEAR
            </button>
        </div>
    </div>
    
    <!-- Chat Messages (Log Stream) -->
    <div class="chat-messages" id="chat-messages">
        <!-- Welcome / Empty State -->
        <template x-if="messages.length === 0">
            <div class="empty-chat-state" style="opacity: 0.5;">
                <div class="agent-avatar-lg" style="border: 2px solid var(--border-mid); color: var(--text-secondary)">
                     <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/><path d="M12 12 2.1 12"/><path d="M12 12l6.9-6.9"/></svg>
                </div>
                <h3 class="font-mono mt-4">SYSTEM READY</h3>
                <p class="font-mono" style="font-size: 0.8rem">Waiting for input...</p>
            </div>
        </template>

        <template x-for="msg in messages" :key="msg.id">
            <div class="message" :class="msg.role">
                <div class="message-avatar">
                    <span x-text="msg.role === 'user' ? 'USR' : 'SYS'" class="font-mono" style="font-size: 0.7rem"></span>
                </div>
                <div class="message-content">
                    <div style="margin-bottom: 4px; font-size: 0.7rem; color: var(--text-tertiary)" class="font-mono" x-text="msg.time + ' | ' + (msg.role === 'user' ? 'INPUT_SRC' : 'GENERATED_RESPONSE')"></div>
                    <div class="tech-card" style="padding: 1rem; border-color: var(--border-dim); background: var(--sys-bg)">
                        <p x-html="formatMessage(msg.content)"></p>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Loading State -->
        <div x-show="loading" class="message assistant" x-transition>
            <div class="message-avatar" style="border-color: var(--primary); color: var(--primary)">SYS</div>
            <div class="message-content">
                <div class="tech-card" style="padding: 1rem; border-color: var(--primary);">
                    <div class="font-mono flex-center gap-2" style="font-size: 0.8rem; color: var(--primary)">
                        <span class="animate-pulse">PROCESSING_QUERY</span>
                        <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sources Panel (Pinned / Floating) -->
    <div x-show="sources.length > 0" class="sources-panel" style="padding: 0.5rem 1rem; background: var(--sys-panel); border-top: 1px solid var(--border-dim); font-family: 'JetBrains Mono'">
        <div style="font-size: 0.7rem; color: var(--text-tertiary); margin-bottom: 0.5rem">REFERENCE_DATA_FOUND:</div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <template x-for="source in sources">
                <span style="font-size: 0.75rem; border: 1px solid var(--accent); color: var(--accent); padding: 2px 6px;">
                    [REF] <span x-text="source"></span>
                </span>
            </template>
        </div>
    </div>
    
    <!-- Input Area (Command Line) -->
    <div class="chat-input" style="background: var(--sys-panel)">
        <form @submit.prevent="sendMessage()">
            <div class="input-wrapper" style="display: flex; align-items: center; border: 1px solid var(--border-mid); background: var(--sys-bg); padding: 0.5rem;">
                <span class="font-mono" style="color: var(--success); padding: 0 0.5rem; font-weight: bold;">root@agent:~#</span>
                <input type="text" x-model="input" placeholder="Enter command or query..." 
                       class="input" 
                       style="border: none; background: transparent; padding: 0.5rem; font-family: 'JetBrains Mono';"
                       :disabled="loading" 
                       autofocus>
                <button type="submit" class="btn btn-primary btn-sm" :disabled="loading || !input.trim()">
                    EXECUTE
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Same logic, format update
function formatMessage(text) {
    if (!text) return '';
    let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary)">$1</strong>');
    formatted = formatted.replace(/`(.*?)`/g, '<code style="background: var(--border-dim); padding: 2px 4px; border-radius: 2px; font-family: \'JetBrains Mono\'">$1</code>');
    formatted = formatted.replace(/\n/g, '<br>');
    return formatted;
}

function chatApp() {
    return {
        messages: [], input: '', loading: false, sessionId: null, sources: [], messageId: 0,
        init() { this.loadHistory(); },
        async loadHistory() {
            try {
                const response = await fetch('/api/chat/history');
                const data = await response.json();
                if (data.success && data.data.messages) {
                    this.sessionId = data.data.session_id;
                    this.messages = data.data.messages.map(m => ({
                        id: ++this.messageId, role: m.role, content: m.content,
                        time: new Date(m.created_at).toLocaleTimeString('en-US', {hour12: false})
                    }));
                    this.scrollToBottom();
                }
            } catch (e) { console.error('Failed to load history:', e); }
        },
        async sendMessage() {
            if (!this.input.trim() || this.loading) return;
            const userMessage = this.input.trim(); this.input = '';
            
            this.messages.push({ 
                id: ++this.messageId, role: 'user', content: userMessage, 
                time: new Date().toLocaleTimeString('en-US', {hour12: false}) 
            });
            this.scrollToBottom(); this.loading = true; this.sources = [];
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: userMessage, session_id: this.sessionId })
                });
                const data = await response.json();
                if (data.success) {
                    this.sessionId = data.data.session_id; 
                    this.sources = data.data.sources || [];
                    this.messages.push({ 
                        id: ++this.messageId, role: 'assistant', content: data.data.message, 
                        time: new Date().toLocaleTimeString('en-US', {hour12: false}) 
                    });
                } else {
                    this.messages.push({ id: ++this.messageId, role: 'assistant', content: 'ERR: ' + (data.error || 'UNKNOWN_FAILURE'), time: new Date().toLocaleTimeString() });
                }
            } catch (e) {
                this.messages.push({ id: ++this.messageId, role: 'assistant', content: 'ERR: SERVER_CONNECTION_LOST', time: new Date().toLocaleTimeString() });
            } finally { 
                this.loading = false; this.scrollToBottom(); 
            }
        },
        async clearHistory() {
            if(!confirm('PURGE SYSTEM LOGS?')) return;
            try { await fetch('/api/chat/history', {method: 'DELETE'}); this.messages = []; this.sessionId = null; this.sources = []; }
            catch (e) { console.error('Failed to clear history:', e); }
        },
        scrollToBottom() { 
            this.$nextTick(() => { 
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight; 
            }); 
        }
    }
}
</script>
<style>
/* Chat Specific Overrides */
.dot { animation: pulse 1s infinite; }
.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }
</style>
{% endblock %}
