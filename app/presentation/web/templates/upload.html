{% extends "base.html" %}
{% block title %}Ingest Module - RAG System{% endblock %}

{% block content %}
<div class="container" x-data="uploadApp()">
    
    <!-- Module Header -->
    <div style="margin-bottom: 2rem; border-bottom: 1px solid var(--border-dim); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-end;">
        <div>
            <div class="sys-badge" style="margin-bottom: 0.5rem">MODULE: INGESTION</div>
            <h1>Document Processing Unit</h1>
            <p style="color: var(--text-secondary)">Upload JSON datasets for vector embedding.</p>
        </div>
        <div class="font-mono" style="font-size: 0.8rem; color: var(--accent)">
            SYS_READY
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
        
        <!-- Upload Card -->
        <div class="tech-card">
            <div class="tech-card-header">
                <span class="font-mono" style="color: var(--text-tertiary)">INPUT_STREAM</span>
                <span class="font-mono" style="color: var(--primary)">[ACTIVE]</span>
            </div>
            
            <form @submit.prevent="handleUpload">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-family: 'JetBrains Mono'; font-size: 0.75rem; margin-bottom: 0.5rem; color: var(--text-secondary); text-transform: uppercase;">Target Filename</label>
                    <input type="text" x-model="filename" placeholder="dataset_v1.json" class="input font-mono" required>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-family: 'JetBrains Mono'; font-size: 0.75rem; margin-bottom: 0.5rem; color: var(--text-secondary); text-transform: uppercase;">Data Payload (JSON)</label>
                    <textarea x-model="jsonContent" class="textarea font-mono" rows="12" placeholder='[{"title": "Doc1", "content": "..."}]' required style="background: var(--sys-surface); border: 1px solid var(--border-dim); color: var(--text-primary); font-size: 0.8rem;"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" :disabled="loading">
                    <span x-text="loading ? 'PROCESSING SEQUENCE...' : 'INITIATE UPLOAD'"></span>
                </button>
            </form>
        </div>

        <!-- Status / List Card -->
        <div class="tech-card">
             <div class="tech-card-header">
                <span class="font-mono" style="color: var(--text-tertiary)">VECTOR_INDEX</span>
                <span class="font-mono" x-text="documents.length + ' ENTRIES'"></span>
            </div>

            <div x-show="error" style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); padding: 1rem; margin-bottom: 1rem; color: var(--danger); font-family: 'JetBrains Mono'; font-size: 0.8rem;">
                ERR: <span x-text="error"></span>
            </div>

            <div x-show="loading" style="text-align: center; padding: 2rem; color: var(--primary);">
                <div style="font-family: 'JetBrains Mono'; animation: pulse 1s infinite">SYNCING TO VECTOR_DB...</div>
            </div>

            <ul class="doc-list" x-show="!loading" style="max-height: 500px; overflow-y: auto;">
                <template x-for="doc in documents" :key="doc.id">
                    <li class="doc-item">
                        <div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--text-primary)" x-text="doc.filename"></div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary)" x-text="'ID: ' + doc.id.substring(0,8) + '...' + ' | ' + new Date(doc.created_at).toLocaleDateString()"></div>
                        </div>
                        <span class="doc-badge" style="background: var(--surface); border: 1px solid var(--success); color: var(--success)">INDEXED</span>
                    </li>
                </template>
                <li x-show="documents.length === 0" style="padding: 2rem; text-align: center; color: var(--text-tertiary); font-family: 'JetBrains Mono'">
                    NO_DATA_FOUND
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function uploadApp() {
    return {
        filename: '',
        jsonContent: '',
        loading: false,
        error: null,
        documents: [],
        
        init() {
            this.loadDocuments();
        },
        
        async loadDocuments() {
            try {
                this.loading = true;
                const res = await fetch('/api/documents'); 
                const data = await res.json();
                if(data.success && data.data) {
                    // Handle structure difference if any
                    this.documents = data.data.documents || data.data;
                }
            } catch(e) {
                console.error("Fetch error", e);
            } finally {
                this.loading = false;
            }
        },
        
        async handleUpload() {
            this.loading = true;
            this.error = null;
            try {
                // Validation
                let parsed;
                try {
                    parsed = JSON.parse(this.jsonContent);
                } catch(e) {
                    throw new Error("INVALID_JSON_FORMAT");
                }
                
                if(!Array.isArray(parsed)) {
                    throw new Error("PAYLOAD_MUST_BE_ARRAY");
                }

                const res = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filename: this.filename,
                        documents: parsed
                    }) // Match backend expectation: "documents" field if pydantic, or "content" if simple
                });
                
                // Note: Previous code used { filename, content: parsed }, check backend. 
                // Assuming standard RAG payload often uses 'documents' list. 
                // If backend expects 'content', we might need to adjust.
                // Let's stick to the previous working format which seemed to be {filename, content}.
                
                // ADJUSTMENT: The viewed file used { filename:this.filename, content: parsed }
                // So I will revert to that to ensure backend compatibility
                
            } catch(e) {
                // We'll re-run fetch with correct body below
            }
            
            // Retry block for Fetch
            try {
                 let parsed = JSON.parse(this.jsonContent);
                 const res = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filename: this.filename, content: parsed })
                });
                const data = await res.json();
                if(!data.success) throw new Error(data.error || "Unknown Error");
                
                this.filename = '';
                this.jsonContent = '';
                this.loadDocuments();
                alert("UPLOAD_COMPLETE: ACKNOWLEDGED");
            } catch(e) {
                this.error = e.message;
            } finally {
                this.loading = false;
            }
        }
    }
}
</script> 
{% endblock %}
